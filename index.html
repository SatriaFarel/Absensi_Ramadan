<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absensi Tadarus</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

</head>

<body class="bg-gradient-to-br from-slate-100 to-slate-200 min-h-screen p-6">

<div class="max-w-7xl mx-auto space-y-8">

  <div class="bg-white rounded-2xl shadow-lg p-8 text-center border">
    <h1 class="text-3xl font-bold text-slate-800">
      ABSENSI TADARUS AL-QUR'AN RAMADHAN 1447 H
    </h1>
    <p class="text-slate-600 text-lg mt-2">Masjid Anwarul Hidayah</p>
  </div>

  <div class="bg-white rounded-2xl shadow-md p-6 flex flex-wrap gap-4 items-center justify-between">

    <div class="flex gap-3">
      <input id="namaInput" type="text"
        placeholder="Masukkan Nama Peserta..."
        class="border border-slate-300 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 px-4 py-2 rounded-lg w-64 outline-none">

      <button onclick="tambahPeserta()"
        class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2 rounded-lg">
        Tambah
      </button>
    </div>

    <div class="flex gap-3">
      <button onclick="exportJSON()" class="bg-emerald-600 text-white px-4 py-2 rounded-lg">Export JSON</button>
      <button onclick="exportPDF()" class="bg-rose-600 text-white px-4 py-2 rounded-lg">Export PDF</button>
      <label class="bg-amber-500 text-white px-4 py-2 rounded-lg cursor-pointer">
        Import JSON
        <input type="file" hidden onchange="importJSON(event)">
      </label>
    </div>
  </div>

  <div class="bg-white rounded-2xl shadow-md p-6 overflow-x-auto">
    <table class="border-collapse text-xs w-full">
      <thead>
        <tr id="headerRow" class="bg-indigo-700 text-white">
          <th class="border px-2 py-2">No</th>
          <th class="border px-2 py-2">Nama</th>
          <th class="border px-2 py-2">Aksi</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<script>

const STORAGE_KEY = "absensi_tadarus_ramadhan";
let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

function generateHeader() {
  const headerRow = document.getElementById("headerRow");
  if (headerRow.children.length === 3) {
    for (let i = 1; i <= 30; i++) {
      const th = document.createElement("th");
      th.className = "border px-1 py-2";
      th.textContent = i;
      headerRow.appendChild(th);
    }
  }
}

function render() {
  generateHeader();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";

  data.forEach((item, index) => {

    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-50";

    // Nomor
    const tdNo = `<td class="border text-center">${index+1}</td>`;

    // Nama editable
    const tdNama = `
      <td class="border px-2">
        <input value="${item.nama}"
          class="w-full bg-transparent outline-none"
          onchange="editNama(${index}, this.value)">
      </td>
    `;

    // Tombol hapus
    const tdAksi = `
      <td class="border text-center">
        <button onclick="hapusPeserta(${index})"
          class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs">
          Hapus
        </button>
      </td>
    `;

    tr.innerHTML = tdNo + tdNama + tdAksi;

    // Checkbox 1-30
    item.hadir.forEach((val, hariIndex) => {
      const td = document.createElement("td");
      td.className = "border text-center";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = val;
      cb.className = "accent-indigo-600";

      cb.addEventListener("change", () => {
        data[index].hadir[hariIndex] = cb.checked;
        save();
      });

      td.appendChild(cb);
      tr.appendChild(td);
    });

    tbody.appendChild(tr);
  });
}

function tambahPeserta() {
  const input = document.getElementById("namaInput");
  const nama = input.value.trim();
  if (!nama) return;

  data.push({
    nama: nama,
    hadir: Array(30).fill(false)
  });

  input.value = "";
  save();
  render();
}

function editNama(index, value) {
  data[index].nama = value.trim();
  save();
}

function hapusPeserta(index) {
  if (!confirm("Yakin mau hapus peserta ini?")) return;
  data.splice(index, 1);
  save();
  render();
}

function exportJSON() {
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "absensi_tadarus.json";
  a.click();
}

function importJSON(e) {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(evt) {
    try {
      const imported = JSON.parse(evt.target.result);
      if (!Array.isArray(imported)) throw "Format salah";
      data = imported;
      save();
      render();
    } catch {
      alert("File JSON tidak valid");
    }
  };
  reader.readAsText(file);
}

function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("landscape");

  doc.setFontSize(15);
  doc.text("ABSENSI TADARUS RAMADHAN 1447 H", 148, 10, { align: "center" });
  doc.text("Masjid Anwarul Hidayah", 148, 17, { align: "center" });

  const headers = ["No", "Nama"];
  for (let i = 1; i <= 30; i++) headers.push(i.toString());

  const rows = data.map((item, index) => [
    index+1,
    item.nama,
    ...item.hadir.map(h => h ? "O" : "X")
  ]);

  doc.autoTable({
    startY: 22,
    head: [headers],
    body: rows,
    theme: "grid",
    styles: { fontSize: 7 }
  });

  doc.save("absensi_tadarus.pdf");
}

render();

</script>

</body>
      </html>
